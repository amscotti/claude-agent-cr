# Claude Agent SDK for Crystal

> An unofficial Anthropic Agent SDK for Crystal that provides a programmatic interface to the Claude Code CLI. Enables building autonomous AI agents that can execute commands, edit files, and perform complex multi-step workflows.
>
> Tested with Claude Code CLI **v2.1.29**. All features verified working.

This SDK communicates with the Claude Code CLI via JSON over stdin/stdout using `--output-format stream-json` and `--input-format stream-json` flags. This is the same architecture used by the official Claude Code Agent SDKs. The CLI handles authentication, the agent loop, built-in tools, and API communication.

## Key Features

- One-shot queries and interactive sessions
- V2 streaming interface with send/receive patterns
- Type-safe JSON Schema builder (Crystal's answer to Zod)
- Structured outputs with JSON schema validation
- Custom tool definitions with MCP server support (stdio, HTTP, SSE)
- In-process SDK MCP servers with control protocol (same as official SDKs)
- Preset types for system prompt and tools (ToolsPreset, SystemPromptPreset)
- Subagent definitions for specialized tasks
- Full hook support (PreToolUse, PostToolUse, PreCompact, Notification, etc.)
- Permission management with callbacks
- Session management (resume, fork, continue, resume_session_at)
- File checkpointing and rewind
- Sandbox configuration
- Extended thinking support
- Graceful handling of unknown content block types (forward-compatible)

## Documentation

- [README](https://github.com/amscotti/claude-agent-cr/blob/main/README.md): Installation, usage examples, and API overview
- [CLAUDE.md](https://github.com/amscotti/claude-agent-cr/blob/main/CLAUDE.md): AI assistant context file with project structure

## Core Source Files

- [src/claude-agent-cr.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude-agent-cr.cr): Main module entry point
- [src/claude_agent/cli_client.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/cli_client.cr): CLI process management and JSON communication
- [src/claude_agent/agent_client.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/agent_client.cr): High-level agent client API
- [src/claude_agent/streaming_session.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/streaming_session.cr): V2 streaming interface
- [src/claude_agent/query.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/query.cr): One-shot query helper
- [src/claude_agent/schema.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/schema.cr): Type-safe JSON Schema builder

## Type Definitions

- [src/claude_agent/types/messages.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/types/messages.cr): Message types (AssistantMessage, UserMessage, ResultMessage, etc.)
- [src/claude_agent/types/content_blocks.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/types/content_blocks.cr): Content block types (TextBlock, ToolUseBlock, etc.)
- [src/claude_agent/types/options.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/types/options.cr): AgentOptions and configuration types
- [src/claude_agent/types/control_messages.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/types/control_messages.cr): Control protocol types for SDK MCP server communication

## Schema Builder API

The Schema module provides type-safe JSON schema generation (Crystal's answer to Zod):

```crystal
# Basic types
Schema.string(description, min_length:, max_length:, pattern:, format:)
Schema.integer(description, minimum:, maximum:)
Schema.number(description, minimum:, maximum:)  # floats
Schema.boolean(description)

# Complex types
Schema.array(items_schema, description, min_items:, max_items:)
Schema.object(properties_hash, required:, description:, additional_properties:)
Schema.enum(["value1", "value2"], description)  # string literals

# Combinators
Schema.optional(schema)  # union with null
Schema.union(schema1, schema2, ...)  # oneOf

# Usage with tools
tool = ClaudeAgent.tool(
  name: "my_tool",
  description: "Tool description",
  schema: Schema.object({
    "param" => Schema.string("Parameter description"),
  }, required: ["param"])
) { |args| ToolResult.text("result") }

# Usage with structured outputs
options = AgentOptions.new(
  output_format: OutputFormat.json_schema(schema, name: "Name", description: "...")
)
```

## Tools and MCP

- [src/claude_agent/tools/sdk_tool.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/tools/sdk_tool.cr): Custom tool definition helpers
- [src/claude_agent/tools/sdk_mcp_server.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/tools/sdk_mcp_server.cr): MCP server implementation

### SDK MCP Server Workflow

Create in-process custom tools (same architecture as official Claude Code SDKs):

```crystal
# 1. Define tools
tool = ClaudeAgent.tool(name: "name", description: "desc", schema: schema) { |args| ToolResult.text("result") }

# 2. Create SDK MCP server
server = ClaudeAgent.create_sdk_mcp_server(name: "server-name", tools: [tool])

# 3. Configure agent
mcp_servers = {} of String => ClaudeAgent::MCPServerConfig
mcp_servers["server-name"] = server

options = AgentOptions.new(
  mcp_servers: mcp_servers,
  allowed_tools: ["mcp__server-name__tool-name"]  # Pattern: mcp__<server>__<tool>
)

# 4. Query - tools execute in your Crystal process
ClaudeAgent.query("prompt", options) { |msg| ... }
```

### External MCP Servers

Connect to external MCP servers:

```crystal
mcp_servers = {} of String => ClaudeAgent::MCPServerConfig
mcp_servers["name"] = ExternalMCPServerConfig.stdio("command", ["args"])  # Local process
mcp_servers["name"] = ExternalMCPServerConfig.http("https://url")         # HTTP
mcp_servers["name"] = ExternalMCPServerConfig.sse("https://url")          # SSE streaming
```

## Hooks and Permissions

- [src/claude_agent/hooks.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/hooks.cr): Hook system with all events (PreToolUse, PostToolUse, PostToolUseFailure, PermissionRequest, PreCompact, Notification, UserPromptSubmit, Stop, SubagentStart, SubagentStop, SessionStart, SessionEnd)
- [src/claude_agent/permissions.cr](https://github.com/amscotti/claude-agent-cr/blob/main/src/claude_agent/permissions.cr): Permission callback system

### Hook Events

| Event | Description | Event-Specific Fields |
|-------|-------------|----------------------|
| PreToolUse | Before tool execution (can block/modify) | `tool_name`, `tool_input`, `tool_use_id` |
| PostToolUse | After successful tool execution | `tool_name`, `tool_input`, `tool_use_id`, `tool_result`/`tool_response` |
| PostToolUseFailure | After tool execution failure | `tool_name`, `tool_input`, `tool_use_id`, `error`, `is_interrupt` |
| PermissionRequest | When permission dialog appears | `tool_name`, `tool_input`, `tool_use_id`, `permission_suggestions` |
| PreCompact | Before conversation compaction | `trigger`, `custom_instructions` |
| Notification | Agent status notifications | `notification_message`, `notification_title`, `notification_type` |
| UserPromptSubmit | When user submits prompt | `user_prompt` |
| Stop | When agent stops | `stop_hook_active` |
| SubagentStart | Subagent initialization | `agent_id`, `agent_type` |
| SubagentStop | Subagent completion | `agent_id`, `agent_type`, `agent_transcript_path`, `stop_hook_active` |
| SessionStart | Session initialization | `source` |
| SessionEnd | Session termination | `session_end_reason` |

### Compact Boundary Detection

When the CLI compacts a session, it emits a `CompactBoundaryMessage`:

```crystal
when ClaudeAgent::CompactBoundaryMessage
  puts "Compacted: #{message.compact_metadata.trigger}"
  puts "Pre-tokens: #{message.compact_metadata.pre_tokens}"
end
```

### Tool Use ID Access

Tool use IDs are available on `ToolUseBlock`:

```crystal
when ClaudeAgent::AssistantMessage
  message.content.each do |block|
    if block.is_a?(ClaudeAgent::ToolUseBlock)
      puts "Tool: #{block.name}, ID: #{block.id}"
    end
  end
end
```

### Interrupt/Cancellation

```crystal
client.interrupt  # Signal CLI to stop current operation
```

### Thinking Content Access

```crystal
when ClaudeAgent::AssistantMessage
  message.content.each do |block|
    case block
    when ClaudeAgent::ThinkingBlock
      puts block.thinking
    when ClaudeAgent::RedactedThinkingBlock
      puts "Redacted: #{block.signature}"
    end
  end
end
```

### HookInput Fields

Common context fields (available on all hook events):
- `session_id` - Current session identifier
- `transcript_path` - Path to the JSONL transcript file
- `cwd` - Current working directory
- `permission_mode` - Permission mode (e.g., "Default", "BypassPermissions")
- `hook_event_name` - Hook event name (e.g., "PreToolUse", "PreCompact", "Stop")

Event-specific fields:
- `tool_name`, `tool_input`, `tool_use_id` - Tool-related fields
- `tool_result`, `tool_response` - Tool execution results
- `error`, `is_interrupt` - PostToolUseFailure fields
- `user_prompt` - For UserPromptSubmit
- `notification_message`, `notification_title`, `notification_type` - For Notification hook
- `trigger`, `custom_instructions` - For PreCompact hook
- `stop_hook_active` - For Stop/SubagentStop hooks
- `agent_id`, `agent_type`, `agent_transcript_path` - For subagent hooks
- `source` - For SessionStart
- `session_end_reason` - For SessionEnd
- `permission_suggestions` - For PermissionRequest

## Examples

- [examples/01_basic_query.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/01_basic_query.cr): Basic one-shot query
- [examples/06_sdk_mcp_server.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/06_sdk_mcp_server.cr): In-process SDK MCP server with custom tools
- [examples/11_custom_tool.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/11_custom_tool.cr): Custom tool definitions with Schema builder
- [examples/13_hooks.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/13_hooks.cr): Hook usage for tool interception
- [examples/14_streaming_session.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/14_streaming_session.cr): V2 streaming interface
- [examples/15_subagents.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/15_subagents.cr): Subagent configuration
- [examples/16_structured_output.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/16_structured_output.cr): Structured output handling
- [examples/17_mcp_playwright.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/17_mcp_playwright.cr): External MCP server (Playwright)
- [examples/18_mcp_github.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/18_mcp_github.cr): GitHub MCP server
- [examples/19_mcp_remote.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/19_mcp_remote.cr): Remote SSE MCP server (Context7)
- [examples/20_hook_lifecycle.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/20_hook_lifecycle.cr): Hook lifecycle (SessionStart/End, Stop, UserPromptSubmit)
- [examples/21_hook_tool_audit.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/21_hook_tool_audit.cr): PostToolUse/PostToolUseFailure auditing
- [examples/22_hook_precompact.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/22_hook_precompact.cr): PreCompact transcript archiving
- [examples/23_hook_permission_request.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/23_hook_permission_request.cr): PermissionRequest hook event
- [examples/24_thinking_interrupt_tool_ids.cr](https://github.com/amscotti/claude-agent-cr/blob/main/examples/24_thinking_interrupt_tool_ids.cr): Thinking blocks, interrupts, tool ID correlation

## Optional

- [spec/](https://github.com/amscotti/claude-agent-cr/tree/main/spec): Test files
- [shard.yml](https://github.com/amscotti/claude-agent-cr/blob/main/shard.yml): Crystal shard configuration

## Version Notes

- **0.3.0**: Full hook parity, CompactBoundaryMessage for session compaction detection, all event-specific fields, PermissionRequest hook event
- **0.2.0**: Added UnknownBlock, Notification hook, resume_session_at, PreCompact hook fields, fixed hook callback dispatch
- Tested with Claude Code CLI v2.1.29
